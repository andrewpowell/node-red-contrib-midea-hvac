<script type="text/html" data-template-name="midea-cloud">

  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row">
    <label for="node-input-account"><i class="fa fa-address-book"></i> Account</label>
    <input type="text" id="node-input-account">
  </div>

  <div class="form-row">
    <label for="node-input-device"><i class="fa fa-tasks"></i> Device</label>
    <input type="text" id="node-input-device">
  </div>

  <div class="form-tips">
    <span id="method-usage">
      Empty/timestamp payload get information from HVAC
    </span>
  </div>
</script>

<script type="text/html" data-help-name="midea-cloud">
  <p>Control HVAC in Midea Cloud</p>
</script>

<script type="text/javascript">
  RED.nodes.registerType('midea-cloud', {
    category: 'devices',
    color: '#D8BFD8',
    defaults: {
      name: { value: '', required: false },
      account: { type: 'midea-cloud-account', required: true },
      device: { value: '', required: false },
    },
    inputs: 1,
    outputs: 1,
    icon: "white-globe.png",
    align: 'left',
    label: function () {
      return (this.name || 'midea cloud');
    },
    oneditprepare: function () {
      let node = this;

      $('#node-input-account').on('change', function () {
        var value = $('#node-input-device').val();
        var account = RED.nodes.node($('#node-input-account').val());

        $('#node-input-device').off('change');
        $('#node-input-device').replaceWith('<input type="text" id="node-input-device">');
        $('#node-input-device').val(value);

        if (account && account.id) {
          $.getJSON('/midea/cloud/devices', {
            controller: account.id,
          }).done(function (data, textStatus, jqXHR) {
            if (!data.error) {
              if (data.length === 0) {
                RED.notify('No devices retrieved, check your HVAC connection settings', 'error');
                return;
              }

              $('#node-input-device').replaceWith('<select id="node-input-device" style="width: 70%;"></select>');
              $('#node-input-device').append('<option value=""></option>');

              data.forEach(function (device) {
                $('#node-input-device').append('<option value="' + device.name + ':' + device.id + '" data-name="' + device.name + '" data-id="' + device.id + '">' + device.name + ':' + device.id + '</option>');
              });

              $('#node-input-device').val(value);
            } else {
              RED.notify(data.error, 'error');
            }
          });
        }
      });
    }
  });
</script>